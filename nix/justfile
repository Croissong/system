all: iso lxd-create

iso:
  #!/usr/bin/env bash
  set -euxo pipefail
  cd {{justfile_directory()}}
  nixos-generate --format iso --configuration ./iso.nix -o nix-iso-out
  sudo mv nix-iso-out/iso/nixos-*.iso nix-iso-out/iso/nixos.iso

lxd-create:
  #!/usr/bin/env bash
  set -euxo pipefail
  cd {{justfile_directory()}}/vm
  sudo -E lxc launch nix nix --vm < lxc-vm.yml
  # lxc config edit nix

lxd-provision:
  #!/usr/bin/env bash
  set -euxo pipefail
  lxc exec nix --cwd /home/nixos -- \
  /run/current-system/sw/bin/bash -c \
  'source /etc/profile; su nixos -s /tmp/share/provision.sh'


view:
  lxc start nix || true
  sudo -E lxc console --type=vga nix


debug:
  lxc exec nix --cwd /home/nixos -- \
  /run/current-system/sw/bin/bash -c \
  'source /etc/profile; su nixos -s /run/current-system/sw/bin/bash -c "sudo lsof | grep mnt"'
